<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HotDoc Register</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="login-container">
  <!-- Left side camera with background -->
  <div class="login-left m-5 d-flex flex-column align-items-center justify-content-start p-3 rounded"
       style="background: url('{{ url_for('static', filename='hotdoc.png') }}') center/cover no-repeat;">

    <!-- Camera frame -->
    <video id="video" autoplay playsinline muted class="w-100 border rounded shadow" style="max-width:480px; background-color: rgba(208, 208, 208, 0.9);">
    </video>
    <!-- Status + progress -->
    <div class="w-100 border rounded shadow" style="max-width:480px; background-color: rgba(208, 208, 208, 0.9);">
    <div id="status" class="mt-2 text-center"></div>
    <progress id="progress" max="{{ embed_target }}" value="0" class="w-100"></progress>
    <div class="text-muted small mt-1 text-center">
      Need {{ embed_target }} frames. Click <code>Capture Frame</code> for each sample.
    </div>
    
    <!-- Buttons stacked below camera -->
    <div class="mt-3 d-flex flex-column gap-2 w-100 align-items-center">
      <button id="btnStart" class="btn btn-secondary w-75" style="display:none;">Start Camera</button>
      <button id="btnCapture" class="btn btn-outline-primary w-75" style="display:none;">Capture Frame</button>
      <button id="btnFinalize" class="btn btn-success w-75" style="display:none;">Finalize & Save</button>
    </div>
  </div>
  </div>

  <!-- Right side form -->
  <div class="login-right m-5">
    <div class="d-flex justify-content-end">
        <img src="{{ url_for('static', filename='logo.png') }}" id="logo" alt="logo">
    </div>
    <div class="my-">
        <h4 class="text-center mb-4">Create Your HotDoc Account</h4>

    <div class="toggle-buttons">
      <a href="#" class="btn btn-outline-success">Login</a>
      <a href="/" class="btn active">Register</a>
    </div>

    <p class="text-center text-muted">
      Please fill in the details below to create your account.
    </p>

    <form id="registerForm">
      <div class="mb-3">
        <input id="fullName" type="text" class="form-control" placeholder="Full Name">
      </div>
      <div class="mb-3">
        <input id="phoneNumber" type="number" class="form-control" placeholder="Phone number">
      </div>
      <div class="mb-3">
        <input id="username" type="text" class="form-control" placeholder="Username">
      </div>
      <div class="mb-3">
        <input id="email" type="email" class="form-control" placeholder="Email">
      </div>
      <div class="mb-3">
        <input id="password" type="password" class="form-control" placeholder="Password">
      </div>
      <div class="mb-3">
        <input id="confirmPassword" type="password" class="form-control" placeholder="Confirm Password">
      </div>
      <button type="submit" class="btn btn-login w-100 text-white">Register</button>
    </form>
    </div>
  </div>
</div>

<script>
const EMBED_SAMPLES_TARGET = {{ embed_target }};
const form = document.getElementById("registerForm");

const video = document.getElementById("video");
const statusEl = document.getElementById("status");
const progressEl = document.getElementById("progress");
const btnStart = document.getElementById("btnStart");
const btnCapture = document.getElementById("btnCapture");
const btnFinalize = document.getElementById("btnFinalize");

let stream = null;
let currentUsername = null;

function setStatus(html) { statusEl.innerHTML = html; }
function disable(el, state) { el.disabled = state; }

async function postJSON(url, body) {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  return res.json();
}

// Step 1: Submit form -> store in memory
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const full_name = document.getElementById("fullName").value.trim();
  const phone_number = document.getElementById("phoneNumber").value.trim();
  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirmPassword = document.getElementById("confirmPassword").value;

  if (password !== confirmPassword) {
    alert("Passwords do not match!");
    return;
  }

  const data = await postJSON("/api/register_pending", { full_name, phone_number, username, email, password });
  if (!data.ok) {
    alert("Error: " + data.error);
    return;
  }

  currentUsername = username;
  alert("User details stored. Please capture your face embeddings.");
  btnStart.click();
});

// Step 2: Start camera
btnStart.addEventListener("click", async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    setStatus("<span class='text-success'>Camera started.</span>");
    btnCapture.style.display = "inline-block";
    btnFinalize.style.display = "inline-block";
    progressEl.value = 0;
  } catch (e) {
    setStatus("<span class='text-danger'>Could not access camera: " + e.message + "</span>");
  }
});

// Step 3: Capture frame
btnCapture.addEventListener("click", async () => {
  if (!stream || !currentUsername) return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
  setStatus("<span class='badge bg-secondary'>Uploading frame…</span>");
  disable(btnCapture, true);

  const data = await postJSON("/api/upload_frame", { username: currentUsername, image: dataUrl });
  disable(btnCapture, false);

  if (!data.ok) {
    setStatus("<span class='text-warning'>" + (data.error || "Frame rejected") + "</span>");
    return;
  }
  progressEl.value = data.count;
  if (data.done) {
    setStatus("<span class='text-success'>Enough samples collected. Click Finalize & Save.</span>");
  } else {
    setStatus("<span class='text-success'>Captured sample " + data.count + " / " + EMBED_SAMPLES_TARGET + ".</span>");
  }
});

// Step 4: Finalize and Save -> insert into DB + embeddings
btnFinalize.addEventListener("click", async () => {
  if (!currentUsername) return;
  setStatus("<span class='badge bg-secondary'>Finalizing…</span>");
  disable(btnFinalize, true);
  const data = await postJSON("/api/finalize", { username: currentUsername });
  disable(btnFinalize, false);

  if (!data.ok) {
    setStatus("<span class='text-danger'>" + (data.error || "Finalize failed") + "</span>");
    return;
  }
  setStatus("<span class='text-success'>User & embeddings saved for <b>" + currentUsername + "</b>.</span>");
  btnCapture.style.display = "none";
  btnFinalize.style.display = "none";

  // Close camera automatically
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }
});
</script>

</body>
</html>
